#!/usr/bin/env perl
use strict;
use warnings FATAL => 'all';
use feature qw(:5.24);
use Cwd 'abs_path';
use POSIX 'strftime';

my $when = strftime "%Y%m%d-%H%M%S", localtime;
my $script_full_path = abs_path($0);

my $old = "/etc/nginx/nginx.conf";
my $tmp = "$old.tmp.$when";
my $back = "$old.back.$when";

my $nginx_access_log_conf = <<'EOF';
        # Auto generated by %HEADER%
        # for Kataribe : Access log profiler based on response time
        # repo: https://github.com/matsuu/kataribe
        log_format with_time '$remote_addr - $remote_user [$time_local] '
        '"$request" $status $body_bytes_sent '
        '"$http_referer" "$http_user_agent" $request_time';
        access_log /var/log/nginx/access.log with_time;
EOF

if (-f "/etc/nginx/nginx.conf") {
    open my $fh_old, "< $old" or die "can't open $old";
    open my $fh_tmp, "> $tmp" or die "can't open $tmp";

    my $modified = 0;
    while (<$fh_old>) {
        if ($_ =~ /access_log \/var\/log\/nginx\/access\.log;$/) {
            $nginx_access_log_conf =~ s#%HEADER%#$script_full_path#;
            print $fh_tmp $nginx_access_log_conf;
            say "$old is modified. backup will be $back";
            $modified = 1;
        } else {
            print $fh_tmp $_;
        }
    }

    close($fh_old);
    close($fh_tmp);

    if ($modified) {
        rename($old, $back);
        rename($tmp, $old);

        system "systemctl reload nginx";
    } else {
        system "rm $tmp";
    }
}

1;
